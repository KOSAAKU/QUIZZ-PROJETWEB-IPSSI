<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Entreprise - Quizzeo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/assets/css/style.css">
</head>
<body class="bg-gray-100">

    <header class="bg-white shadow-md">
        <nav class="container mx-auto px-6 py-3 flex justify-between items-center">
            <a href="/" class="text-2xl font-bold text-gray-800"> <img class="h-9" src="/assets/img/img1.png" alt=""> </a>
            <div>
                <a href="/logout" class="px-4 py-2 leading-none rounded-lg btn-secondary text-white">Déconnexion</a>
            </div>
        </nav>
    </header>

    <main class="container mx-auto px-6 py-12">
        <h1 class="text-3xl font-bold text-gray-800 mb-6">Dashboard Entreprise</h1>
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Création de Quiz</h2>
                <a href="/quizz/create" class="btn-primary w-full py-2 rounded-lg text-center inline-block">Créer un nouveau quiz</a>
                 <div class="overflow-x-auto mt-4">
                    <table class="w-full text-left">
                        <thead>
                            <tr class="bg-gray-200">
                                <th class="p-3">#</th>
                                <th class="p-3">Quiz</th>
                                <th class="p-3">Participants</th>
                                <th class="p-3">Statut</th>
                                <th class="p-3">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <footer class="bg-white mt-16 py-6">
        <div class="container mx-auto px-6 text-center text-gray-600">
            <p>&copy; 2025 Quizzeo - Tous droits réservés</p>
        </div>
        <script>
            function shareQuiz(quizId, quizName) {
                const baseUrl = window.location.origin;
                const quizUrl = `${baseUrl}/quizz/${quizId}`;

                // Try to copy to clipboard
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(quizUrl).then(() => {
                        alert(`Lien copié dans le presse-papier!\n\n${quizUrl}\n\nPartagez ce lien avec les participants pour qu'ils puissent accéder au quiz "${quizName}".`);
                    }).catch(() => {
                        // Fallback if clipboard API fails
                        prompt('Copiez ce lien pour partager le quiz:', quizUrl);
                    });
                } else {
                    // Fallback for older browsers
                    prompt('Copiez ce lien pour partager le quiz:', quizUrl);
                }
            }

            function toggleQuiz(quizId, currentStatus) {
                if (!confirm(`Êtes-vous sûr de vouloir ${currentStatus === 'pending' ? 'démarrer' : 'terminer'} ce quiz?`)) {
                    return;
                }

                fetch(`/quizz/${quizId}/toggle`, {
                    method: 'GET',
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Échec du changement de statut');
                    }
                    return response.json();
                })
                .then(() => {
                    alert('Statut du quiz mis à jour avec succès!');
                    location.reload();
                })
                .catch(error => {
                    console.error('Error toggling quiz:', error);
                    alert('Erreur lors du changement de statut: ' + error.message);
                });
            }

            function deleteQuiz(quizId, quizName) {
                if (!confirm(`Êtes-vous sûr de vouloir supprimer le quiz "${quizName}"? Cette action est irréversible.`)) {
                    return;
                }

                fetch(`/quizz/${quizId}/delete`, {
                    method: 'DELETE',
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Échec de la suppression');
                    }
                    return response.json();
                })
                .then(() => {
                    alert('Quiz supprimé avec succès!');
                    location.reload();
                })
                .catch(error => {
                    console.error('Error deleting quiz:', error);
                    alert('Erreur lors de la suppression: ' + error.message);
                });
            }

            document.addEventListener('DOMContentLoaded', function() {
                fetch('/quizz/quizzes')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`Erreur réseau: ${response.status} ${response.statusText}`);
                        }
                        return response.json();
                    })
                    .then(payload => {
                        const quizzes = payload.quizzs || [];
                        const tbody = document.querySelector('table tbody');
                        tbody.innerHTML = '';

                        if (quizzes.length === 0) {
                            const emptyRow = document.createElement('tr');
                            emptyRow.innerHTML = `<td class="p-3" colspan="5">Aucun quizz trouvé.</td>`;
                            tbody.appendChild(emptyRow);
                            return;
                        }

                        quizzes.forEach((quiz, index) => {
                            const row = document.createElement('tr');
                            const title = quiz.name || quiz.title || 'Sans titre';
                            const participants = quiz.participants ?? '-';
                            row.innerHTML = `
                                <td class="p-3">${index + 1}</td>
                                <td class="p-3">${title}</td>
                                <td class="p-3">${participants}</td>
                                <td class="p-3">
                                    <span class="${quiz.status === 'pending' ? 'border-2 border-yellow-500 bg-yellow-50' : quiz.status === 'started' ? 'border-2 border-blue-500 bg-blue-50' : quiz.status === 'finish' ? 'border-2 border-green-500 bg-green-50' : 'border-2 border-gray-500 bg-gray-50'} px-3 py-1 rounded">
                                        ${quiz.status}
                                    </span>
                                </td>
                                <td class="p-3">
                                    <a href="/dashboard/quizz/${quiz.id}/" class="text-green-600 hover:underline mr-4">Participations</a>
                                    ${quiz.status === 'started' ? `<button onclick="shareQuiz(${quiz.id}, '${title.replace(/'/g, "\\'")}')" class="text-purple-600 hover:underline mr-4">Partager</button>` : ''}
                                    ${quiz.status !== 'finish' ? `<button onclick="toggleQuiz(${quiz.id}, '${quiz.status}')" class="text-blue-600 hover:underline mr-4">${quiz.status === 'pending' ? 'Démarrer' : 'Terminer'}</button>` : ''}
                                    <button onclick="deleteQuiz(${quiz.id}, '${title.replace(/'/g, "\\'")}')" class="text-red-600 hover:underline">Supprimer</button>
                                </td>
                            `;
                            tbody.appendChild(row);
                        });
                    })
                    .catch(error => {
                        console.error('Error fetching quizzes:', error);
                        const tbody = document.querySelector('table tbody');
                        tbody.innerHTML = `<tr><td class="p-3" colspan="5">Erreur lors du chargement des quizzs: ${error.message}</td></tr>`;
                    });
            });
        </script>
    </footer>
</body>
</html>